<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>房源详情 - AI荐房</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="../assets/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/common.css">
    <style>
        body {
            font-family: 'PingFang SC', 'Helvetica Neue', 'Arial', sans-serif;
            background: #F5F7FA;
            padding-bottom: 80px;
        }

        .price-section {
            background: linear-gradient(135deg, #165DFF 0%, #0F4CD3 100%);
            color: white;
            padding: 20px 16px;
        }

        .section-card {
            background: white;
            margin: 12px 0;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1D2129;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .section-title i {
            color: #165DFF;
            margin-right: 8px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #F5F7FA;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #86909C;
            font-size: 14px;
        }

        .info-value {
            color: #1D2129;
            font-size: 14px;
            font-weight: 500;
        }

        .facility-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #F5F7FA;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .facility-icon {
            width: 40px;
            height: 40px;
            background: #165DFF;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
        }

        .facility-info {
            flex: 1;
        }

        .facility-name {
            font-size: 14px;
            font-weight: 500;
            color: #1D2129;
            margin-bottom: 4px;
        }

        .facility-distance {
            font-size: 12px;
            color: #86909C;
        }

        .agent-card {
            display: flex;
            align-items: center;
            padding: 16px;
            background: #F5F7FA;
            border-radius: 12px;
        }

        .agent-avatar {
            width: 60px;
            height: 60px;
            background: #165DFF;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 16px;
        }

        .agent-info {
            flex: 1;
        }

        .agent-name {
            font-size: 16px;
            font-weight: 600;
            color: #1D2129;
            margin-bottom: 4px;
        }

        .agent-exp {
            font-size: 12px;
            color: #86909C;
        }

        .call-btn {
            width: 40px;
            height: 40px;
            background: #165DFF;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- 返回按钮 -->
    <button class="back-btn" onclick="history.back()">
        <i class="fa fa-arrow-left"></i>
    </button>

    <!-- 图片轮播 -->
    <div class="swiper-container">
        <div class="swiper-wrapper" id="imageSwiper">
            <!-- 动态加载 -->
        </div>
        <div class="swiper-pagination" id="pagination">
            <!-- 动态加载 -->
        </div>
    </div>

    <!-- 价格区域 -->
    <div class="price-section">
        <h1 id="houseName" class="text-2xl font-bold mb-2">加载中...</h1>
        <div class="flex items-end gap-4">
            <div>
                <div class="text-sm opacity-80 mb-1">总价</div>
                <div class="text-3xl font-bold">¥<span id="totalPrice">0</span>万</div>
            </div>
            <div>
                <div class="text-sm opacity-80 mb-1">单价</div>
                <div class="text-xl">¥<span id="price">0</span>/㎡</div>
            </div>
            <div class="ml-auto">
                <div class="bg-white/20 px-3 py-1 rounded-full text-sm">
                    匹配度 <span id="matchRate">0</span>%
                </div>
            </div>
        </div>
    </div>

    <div class="px-4">
        <!-- 基本信息 -->
        <div class="section-card">
            <h2 class="section-title">
                <i class="fa fa-info-circle"></i>
                基本信息
            </h2>
            <div class="info-row">
                <span class="info-label">户型</span>
                <span class="info-value" id="rooms">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">建筑面积</span>
                <span class="info-value"><span id="area">0</span>㎡</span>
            </div>
            <div class="info-row">
                <span class="info-label">房屋类型</span>
                <span class="info-value" id="type">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">交付标准</span>
                <span class="info-value" id="deliveryStandard">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">销售状态</span>
                <span class="info-value text-green-600" id="status">-</span>
            </div>
        </div>

        <!-- 小区信息 -->
        <div class="section-card">
            <h2 class="section-title">
                <i class="fa fa-building"></i>
                小区信息
            </h2>
            <div class="info-row">
                <span class="info-label">开发商</span>
                <span class="info-value" id="developer">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">物业公司</span>
                <span class="info-value" id="property">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">物业费</span>
                <span class="info-value"><span id="propertyFee">0</span>元/㎡/月</span>
            </div>
            <div class="info-row">
                <span class="info-label">绿化率</span>
                <span class="info-value"><span id="greenRate">0</span>%</span>
            </div>
            <div class="info-row">
                <span class="info-label">容积率</span>
                <span class="info-value" id="volumeRate">-</span>
            </div>
        </div>

        <!-- 教育配套 -->
        <div class="section-card">
            <h2 class="section-title">
                <i class="fa fa-graduation-cap"></i>
                教育配套
            </h2>
            <div class="facility-item">
                <div class="facility-icon">
                    <i class="fa fa-bank"></i>
                </div>
                <div class="facility-info">
                    <div class="facility-name" id="schoolName">-</div>
                    <div class="facility-distance"><span id="schoolLevel">-</span> · <span id="schoolDistance">-</span></div>
                </div>
            </div>
        </div>

        <!-- 交通配套 -->
        <div class="section-card">
            <h2 class="section-title">
                <i class="fa fa-subway"></i>
                交通配套
            </h2>
            <div class="facility-item">
                <div class="facility-icon">
                    <i class="fa fa-train"></i>
                </div>
                <div class="facility-info">
                    <div class="facility-name"><span id="metroLine">-</span> <span id="metroStation">-</span></div>
                    <div class="facility-distance">距离约 <span id="metroDistance">-</span></div>
                </div>
            </div>
        </div>

        <!-- 周边配套 -->
        <div class="section-card">
            <h2 class="section-title">
                <i class="fa fa-map-marker"></i>
                周边配套
            </h2>
            <div id="facilitiesList">
                <!-- 动态加载 -->
            </div>
        </div>

        <!-- 楼盘介绍 -->
        <div class="section-card">
            <h2 class="section-title">
                <i class="fa fa-file-text"></i>
                楼盘介绍
            </h2>
            <p id="description" class="text-sm text-gray-700 leading-relaxed">加载中...</p>
        </div>

        <!-- 房源标签 -->
        <div class="section-card">
            <h2 class="section-title">
                <i class="fa fa-tags"></i>
                房源特色
            </h2>
            <div id="tagsList" class="flex flex-wrap gap-2">
                <!-- 动态加载 -->
            </div>
        </div>

        <!-- 经纪人信息 -->
        <div class="section-card">
            <h2 class="section-title">
                <i class="fa fa-user"></i>
                专属经纪人
            </h2>
            <div class="agent-card">
                <div class="agent-avatar">
                    <i class="fa fa-user"></i>
                </div>
                <div class="agent-info">
                    <div class="agent-name" id="agentName">-</div>
                    <div class="agent-exp">从业经验: <span id="agentExp">-</span></div>
                </div>
                <a id="agentPhoneLink" href="tel:" class="call-btn">
                    <i class="fa fa-phone"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- 底部操作栏 -->
    <div class="bottom-bar">
        <button class="btn-secondary" onclick="openConsultModal()">
            <i class="fa fa-comments mr-2"></i>咨询
        </button>
        <button class="btn-primary" onclick="openAppointmentModal()">
            <i class="fa fa-calendar mr-2"></i>预约看房
        </button>
    </div>

    <script>
        // 获取URL参数
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // 加载房源数据
        async function loadHouseData() {
            const houseId = parseInt(getQueryParam('id') || '1');

            try {
                const response = await fetch('../assets/data/houses.json');
                const data = await response.json();
                const house = data.houses.find(h => h.id === houseId);

                if (!house) {
                    alert('房源不存在');
                    history.back();
                    return;
                }

                // 渲染数据
                renderHouseData(house);
            } catch (error) {
                console.error('加载房源数据失败:', error);
                alert('加载失败，请重试');
            }
        }

        // 渲染房源数据
        function renderHouseData(house) {
            // 基本信息
            document.getElementById('houseName').textContent = house.name + '（' + house.district + '）';
            document.getElementById('totalPrice').textContent = house.totalPrice;
            document.getElementById('price').textContent = house.price;
            document.getElementById('matchRate').textContent = house.matchRate;
            document.getElementById('rooms').textContent = house.rooms;
            document.getElementById('area').textContent = house.area;
            document.getElementById('type').textContent = house.type;
            document.getElementById('deliveryStandard').textContent = house.deliveryStandard;
            document.getElementById('status').textContent = house.status;

            // 小区信息
            document.getElementById('developer').textContent = house.developer;
            document.getElementById('property').textContent = house.property;
            document.getElementById('propertyFee').textContent = house.propertyFee;
            document.getElementById('greenRate').textContent = house.greenRate;
            document.getElementById('volumeRate').textContent = house.volumeRate;

            // 学校信息
            document.getElementById('schoolName').textContent = house.school.name;
            document.getElementById('schoolLevel').textContent = house.school.level;
            document.getElementById('schoolDistance').textContent = house.school.distance;

            // 地铁信息
            document.getElementById('metroLine').textContent = house.metro.line;
            document.getElementById('metroStation').textContent = house.metro.station;
            document.getElementById('metroDistance').textContent = house.metro.distance;

            // 周边配套
            const facilitiesList = document.getElementById('facilitiesList');
            facilitiesList.innerHTML = house.facilities.map(f => {
                const iconMap = {
                    '商圈': 'shopping-cart',
                    '医院': 'hospital-o',
                    '公园': 'tree'
                };
                return `
                    <div class="facility-item">
                        <div class="facility-icon">
                            <i class="fa fa-${iconMap[f.type] || 'map-marker'}"></i>
                        </div>
                        <div class="facility-info">
                            <div class="facility-name">${f.name}</div>
                            <div class="facility-distance">${f.type} · 距离${f.distance}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // 楼盘介绍
            document.getElementById('description').textContent = house.description;

            // 标签
            const tagsList = document.getElementById('tagsList');
            const tagColors = ['primary', 'success', 'success', 'warning', 'warning', 'primary'];
            tagsList.innerHTML = house.tags.map((tag, i) =>
                `<span class="tag tag-${tagColors[i % tagColors.length]}">${tag}</span>`
            ).join('');

            // 经纪人
            document.getElementById('agentName').textContent = house.agent.name;
            document.getElementById('agentExp').textContent = house.agent.experience;
            document.getElementById('agentPhoneLink').href = 'tel:' + house.agent.phone;

            // 图片轮播
            const swiper = document.getElementById('imageSwiper');
            const pagination = document.getElementById('pagination');
            const swiperContainer = document.querySelector('.swiper-container');

            swiper.innerHTML = house.images.map(img =>
                `<div class="swiper-slide"><img src="${img}" alt="${house.name}"></div>`
            ).join('');

            pagination.innerHTML = house.images.map((_, i) =>
                `<div class="swiper-pagination-bullet ${i === 0 ? 'active' : ''}" data-index="${i}"></div>`
            ).join('');

            // 轮播功能（支持触摸滑动）
            let currentIndex = 0;
            let startX = 0;
            let isDragging = false;
            let currentTranslate = 0;
            let prevTranslate = 0;

            // 更新分页指示器
            function updatePagination() {
                pagination.querySelectorAll('.swiper-pagination-bullet').forEach((b, i) => {
                    b.classList.toggle('active', i === currentIndex);
                });
            }

            // 设置位置
            function setPositionByIndex() {
                currentTranslate = currentIndex * -100;
                prevTranslate = currentTranslate;
                swiper.style.transform = `translateX(${currentTranslate}%)`;
            }

            // 点击分页指示器
            pagination.querySelectorAll('.swiper-pagination-bullet').forEach(bullet => {
                bullet.addEventListener('click', () => {
                    currentIndex = parseInt(bullet.dataset.index);
                    setPositionByIndex();
                    updatePagination();
                });
            });

            // 触摸开始
            function touchStart(e) {
                startX = e.type.includes('mouse') ? e.pageX : e.touches[0].clientX;
                isDragging = true;
                swiper.style.transition = 'none';
            }

            // 触摸移动
            function touchMove(e) {
                if (!isDragging) return;

                const currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].clientX;
                const diff = currentX - startX;
                const containerWidth = swiperContainer.offsetWidth;
                const movePercent = (diff / containerWidth) * 100;

                currentTranslate = prevTranslate + movePercent;
                swiper.style.transform = `translateX(${currentTranslate}%)`;
            }

            // 触摸结束
            function touchEnd() {
                if (!isDragging) return;
                isDragging = false;

                swiper.style.transition = 'transform 0.3s ease';

                const movedBy = currentTranslate - prevTranslate;

                // 滑动超过30%才切换
                if (movedBy < -30 && currentIndex < house.images.length - 1) {
                    currentIndex++;
                } else if (movedBy > 30 && currentIndex > 0) {
                    currentIndex--;
                }

                setPositionByIndex();
                updatePagination();
            }

            // 绑定事件
            swiperContainer.addEventListener('touchstart', touchStart);
            swiperContainer.addEventListener('touchmove', touchMove);
            swiperContainer.addEventListener('touchend', touchEnd);

            // 支持鼠标拖拽（桌面端）
            swiperContainer.addEventListener('mousedown', touchStart);
            swiperContainer.addEventListener('mousemove', touchMove);
            swiperContainer.addEventListener('mouseup', touchEnd);
            swiperContainer.addEventListener('mouseleave', touchEnd);

            // 防止图片拖拽
            swiper.querySelectorAll('img').forEach(img => {
                img.addEventListener('dragstart', e => e.preventDefault());
            });
        }

        // 打开咨询弹窗
        function openConsultModal() {
            const houseId = getQueryParam('id') || '1';
            window.location.href = `consult.html?id=${houseId}`;
        }

        // 打开预约看房弹窗
        function openAppointmentModal() {
            const houseId = getQueryParam('id') || '1';
            window.location.href = `consult.html?id=${houseId}&type=appointment`;
        }

        // 页面加载
        window.addEventListener('load', loadHouseData);
    </script>
</body>
</html>
